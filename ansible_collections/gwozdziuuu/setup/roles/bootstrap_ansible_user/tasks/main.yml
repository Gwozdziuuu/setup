---
# Tworzy użytkownika 'managed_user' z hasłem 'managed_user_password'
# Założenie: play łączy się kontem z sudo/root (ustawione w playu).

- name: Gather facts
  ansible.builtin.setup:

- name: Determine admin group
  ansible.builtin.set_fact:
    _admin_group: "{{ 'sudo' if ansible_facts.os_family == 'Debian' else 'wheel' }}"

- name: Ensure admin group exists
  become: true
  ansible.builtin.group:
    name: "{{ _admin_group }}"
    state: present

- name: Create {{ managed_user }} user with password and home
  become: true
  ansible.builtin.user:
    name: "{{ managed_user }}"
    comment: "Ansible automation user"
    groups: "{{ _admin_group }}"
    append: true
    shell: /bin/bash
    create_home: true
    password: "{{ managed_user_password | password_hash('sha512') }}"
    state: present
  no_log: true

- name: Sanity check — user exists
  become: true
  ansible.builtin.command: "id -u {{ managed_user }}"
  register: _id_out
  changed_when: false

- name: Show result
  ansible.builtin.debug:
    msg: "User {{ managed_user }} present (uid {{ _id_out.stdout }})"
